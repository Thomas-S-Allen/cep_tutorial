---
title: "Data Wrangling and Visualization"
author: "Thomas Allen"
date: "9/30/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(infer)
```



```{r}

within_radius_of_point <- function(df,point,radius) {
  
  # df : dataframe with RA and Dec columns (Decimal Degrees)
  
  # point : 2-element vector with center point RA and Dec (Decimal Degrees)
  
  # radius : radius to search within (Arcseconds)
  
  
df <-  df %>% 
  
  mutate(new_column_distance = sqrt( ((point[1] - RA) * 3600. * cos((pi/180.)*Dec))^2   +  ((Dec-point[2]) * 3600.)^2)) %>% 
  mutate(new_column = if_else(new_column_distance < radius,"yes", "no"))
  
df
  
}

```


```{r}

df <- read_csv("~/Websites/Working/thomas-s-allen 2/cep_tutorial/data/J.ApJ.750.125.ysos_2MASS_GAIA_raw.csv")

nrow(df)


#east_center <- c(344.2083, 62.6656)
east_center <- c(344.2060000, 62.6654278)
west_center <- c(343.4625, 62.5936)

radius <- 300.

df %>% distinct(Note)

parallax_conversion <- 10^3 # milli arcseconds to arcseconds

cols_to_keep <- c(
                  "RA",
                  "Dec",
                  "Type",
                  "Band1",
                  "Band2",
                  "Band3",
                  "Band4",
                  "Band5",
                  "Band6",
                  "Band7",
                  "Band8",
                  "Band9",
                  "Band10",
                  "Dust",
                  "Xray",
                  "parallax",
                  "parallax_error",
                  "pmra",
                  "pmra_error",
                  "pmdec",
                  "pmdec_error",
                  "teff_val",
                  "a_g_val",
                  "radius_val",
                  "lum_val"
                  )


df <- df %>%
  mutate(`V-I` = Vmag-`V-I`) %>% 
  mutate(Cl = fct_recode(Cl,"no disk"="III","disk"="II","disk"="TD","envelope"="I")) %>% 
  mutate(Note = case_when(Note=="x-ray" ~ "yes",
                            is.na(Note)==TRUE ~ "no")) %>% 
  rename(
    RA = `_RAJ2000`,
    Dec = `_DEJ2000`,
    Type = Cl,
    Band1 = Vmag,
    Band2 = `V-I`,
    Band3 = Jmag,
    Band4 = Hmag,
    Band5 = Ksmag,
    Band6 = `[3.6]`,
    Band7 = `[4.5]`,
    Band8 = `[5.8]`,
    Band9 = `[8.0]`,
    Band10 = `[24]`,
    Xray = Note,
    Dust = AKs
  ) %>% 
  select(cols_to_keep) %>% 
  #filter(Type %in% c("Disk","No Disk")) %>% 
  mutate(Distance = 1/ (parallax/parallax_conversion)) %>% 
  filter(Distance > 0,
         Distance < 10000) %>% 
  within_radius_of_point(east_center,radius) %>% 
  mutate(east_cluster = new_column) %>% 
  select(-new_column) %>% 
  within_radius_of_point(west_center,radius) %>% 
  mutate(west_cluster = new_column) %>% 
  select(-new_column) %>% 
  mutate(Region = if_else(east_cluster=="yes","east",if_else(west_cluster=="yes","west","halo"))) %>% 
  select(-new_column_distance,-east_cluster,-west_cluster)

df
```

## Problem 1

We are interested in exploring whether the presence (or lack thereof) of a protoplanetary disk around a young star depends on the location of that star in its birth cluster.  In this dataset, the `Region` variable gives the location of the stars in the cluster as "east", "west" and "halo". And the `Type` variable states disk presence as "disk", "no disk" and "envelope".  You can either include cases of `Type` "envelope" with the "disk" cases or ignore them.  For this problem:

### Exploratoru Data Analysis

First, we want to explore our data.  Create a useful table and visualization to show the relationship between `Type` and `Region`.

*****************************************************************************************

```{r}

df_counts <- df %>% 
 # filter(Xray=="yes",
 #       Type %in% c("Disk","No Disk")) %>% 
  filter(Type %in% c("disk","no disk")) %>% 
         #Subcluster %in% c("east","west")) %>% 
  group_by(Region,Type) %>% 
  summarize(counts=n()) %>% 
  mutate(freq=counts/sum(counts))

df_counts

df_counts %>% 
  ggplot(aes(x=Region,y=counts,fill=Type)) +
    geom_col(position="fill")

```


### Two Categories

#### Confidence intervals

Now just consider the regions "east" and "west".  For eash region estimate the proportion of stars with a protoplanetary disk and determine $95\%$ confidence intervals.

*****************************************************************************************

##### Approximation with probability models

For a single proprtion point estimate:
$$
\begin{align}
\hat{p} & \pm MOE \\
\hat{p} & \pm z^{*} \times \sqrt{\frac{\hat{p}(1-\hat{p})}{n}}
\end{align}
$$
For the "east" region, since there are 192 stars with a disk and 240 without, $\hat{p} = \frac{192}{192 + 240} = 0.44$:
$$
\begin{align}
\hat{p_{east}} & \pm z^{*} \times \sqrt{\frac{\hat{p}(1-\hat{p})}{n}} \\
0.44 & \pm 1.96 \times \sqrt{\frac{0.44(1-0.44)}{432}} \\
0.44 & \pm 0.05
\end{align}
$$

```{r}

1.96 * sqrt( (0.44 * (1 - 0.44)) / 432)

```
And for the "west" region, since there are 159 stars with a disk and 134 without, $\hat{p} = \frac{159}{159 + 134} = 0.54$:
$$
\begin{align}
\hat{p_{west}} & \pm z^{*} \times \sqrt{\frac{\hat{p}(1-\hat{p})}{n}} \\
0.54 & \pm 1.96 \times \sqrt{\frac{0.54(1-0.54)}{293}} \\
0.54 & \pm 0.06
\end{align}
$$

```{r}

1.96 * sqrt( (0.54 * (1 - 0.54)) / 293)

```
Therefore, we think that a plausable range of values that contain the popultation porportion in the east region is, $p_{east}$, is $0.39 - 0.49$, and for the west, $p_{west}$, is $0.48 - 0.6$.

##### Computational method with Infer

We will use `infer` to construct bootstrap estimations of the sampling distribution.  

```{r}

# First 

df_two <- df %>% 
  filter(Region %in% c("east","west"),
         Type %in% c("disk","no disk")) %>% 
  mutate(Region=factor(Region),
         Type=factor(Type))

df_two %>% 
  group_by(Region, Type) %>%
  summarise(count = n())

# east
prop_east <- df_two %>% 
  filter(Region == "east") %>% 
  specify(response = Type, success = "disk") %>% 
  calculate(stat = "prop")

boot_east <- df_two %>% 
  filter(Region == "east") %>% 
  specify(response = Type, success = "disk") %>% 
  generate(reps=1000,type="bootstrap") %>% 
  calculate(stat = "prop") 

ci_east <- boot_east %>% 
  get_confidence_interval(type = "se", point_estimate = prop_east)

prop_east

ci_east

# west
prop_west <- df_two %>% 
  filter(Region == "west") %>% 
  specify(response = Type, success = "disk") %>% 
  calculate(stat = "prop")

boot_west <- df_two %>% 
  filter(Region == "west") %>% 
  specify(response = Type, success = "disk") %>% 
  generate(reps=1000,type="bootstrap") %>% 
  calculate(stat = "prop") 

ci_west <- boot_west %>% 
  get_confidence_interval(type = "se", point_estimate = prop_west)

prop_east

ci_east



# Construct Bootstrap Distributions

#boot_dist <- df_two %>% 
#  specify(response = Type, success = "disk") %>% 
#  generate(reps=1000, type="bootstrap") %>% 
#  calculate(stat = "prop")

```



```{r}
test_stat <- df_two %>% 
  specify(Type ~ Region, success = "disk") %>% 
  calculate(stat = "z", order = c("east","west"))

test_stat

```


*****************************************************************************************

##### Hypothesis testing

Now answer the question, "Do the proportions of stars with disks differ with region?"  Formulate a null and alterntive hypothesis, calculate a test statistic and a p-value and then make a conclusion about your hypotheis.


We will formulate our hypotheses as:
$$
\begin{align}
H_{0} &: p_{east} - p_{west} = 0 \\
H_{A} &: p_{east} - p_{west} \ne 0

\end{align}
$$

We can calculate a $z-score$ test statistic to test this hypothesis:
$$
\begin{align}
z & = \frac{\hat{p_{east}} - \hat{p_{west}} - 0}{\sqrt{\frac{\hat{p_{east}}(1-\hat{p_{east}})}{n_{east}} + 
    \frac{\hat{p_{west}}(1-\hat{p_{west}})}{n_{west}}}} \\
z & = \frac{0.44 - 0.54 - 0}{\sqrt{\frac{0.44(1-0.44)}{432} + 
    \frac{0.54(1-0.54)}{293}}} \\
z & = -2.66
\end{align}
$$

```{r}

z_score <- (0.44 - 0.54 - 0) / sqrt( (0.44*(1-0.44)/432) + (0.54*(1-0.54)/293))

z_score

```

Now that we have a z-score, we can calculate a p-value.  Our hypotheses call for a two-sided test, so:
```{r}

p_value = 2 * pnorm(q=-2.66, mean=0, sd=1)

p_value

```

This p-value is quite small, and is strong evidence to reject the null hypothesis.  Therefore, we conclude that the proportion of stars with disks differs between the "east" and "west" regions.

#### More than two Categories

##### Confidence Intervals

Does it make sense to calculate a confidence interval when there is more than one category?




# Color as a function of Type


```{r}

df <- df %>% 
  mutate(Color1 = Band3 - Band4,
         Color2 = Band6 - Band7, 
         Color3 = Band8 - Band9)


# Boxplot of Index as function of Type (Disk or No Disk)
df %>% 
  #drop_na(Band3,Band4,Band5,Band6,Band7,Band8,Band9) %>% 
  #mutate(Color1 = Band3-Band4,
  #       Color2 = Band6 - Band7, 
  #       Color3 = Band8 - Band9) %>% 
  ggplot(aes(x=Type, y=Color2)) +
    geom_boxplot()

df %>% 
  #mutate(Color1 = Band3 - Band4,
  #       Color2 = Band6 - Band7, 
  #       Color3 = Band8 - Band9) %>% 
  ggplot(aes(x=Color3,y=Color2,color=Type)) +
    geom_point(alpha=0.1) +
    scale_x_continuous(name='Near Infrared Color Index') +
    scale_y_continuous(name="Mid Infrared Color Index")


df %>% 
  #mutate(Color1 = Band3 - Band4,
  #       Color2 = Band6 - Band7, 
  #       Color3 = Band8 - Band9) %>% 
  ggplot(aes(x=Color3,y=Color2)) +
    geom_point(alpha=0.1) +
    facet_wrap(~Xray) +
    scale_x_continuous(name='Near Infrared Color Index') +
    scale_y_continuous(name="Mid Infrared Color Index")

# Boxplor of Color3 for Xray No Xray for No Disks
df %>% 
  filter(Type=="No Disk") %>% 
  ggplot(aes(x=Xray,y=Color2)) +
  geom_boxplot()
  
```
```{r}

df %>% 
  filter(Type %in% c("No Disk","Disk")) %>%
  ggplot(aes(x=teff_val,y=lum_val,color=Type)) +
  geom_point() + 
  scale_y_continuous(name="Luminosity (Solar Units)", trans="log10") +
  scale_x_reverse(name="Effective Temperature")
 
```


# Distances to "No Disk" stars



```{r}

df %>% 
  filter(Type %in% c("No Disk","Disk")) %>% 
  group_by(Type,Xray) %>% 
  summarize("Mean Distance" = mean(Distance), "StDev Distance" = sd(Distance))
  

df %>% 

  ggplot(aes(x=Distance)) +
    geom_histogram(bins=50)
  

df %>% 
  #filter(Type=="No Disk") %>% 
  filter(Type %in% c("No Disk","Disk")) %>% 
  ggplot(aes(x=Xray,y=Distance)) +
  geom_boxplot() +
  facet_wrap(~Type)

df %>% 
  filter(Type %in% c("No Disk","Disk")) %>% 
  group_by(Type,Xray) %>% 
  summarize(counts=n(),freq=sum(counts))
```

```{r}

df %>% 
  filter(Type %in% c("No Disk","Disk")) %>% 
  #group_by(Type,Xray) %>% 
  ggplot(aes(x=Distance,fill=Xray,color=Xray)) +
    geom_histogram(bin_size=250,alpha=0.2,position="identity") +
    facet_wrap(~Type)# +
    #scale_fill_brewer(type="div")

```

```{r}

df %>% filter(Type=="Disk") %>% 
  ggplot(aes(x=Distance,y=Dust)) +
  geom_point()

```





